---
   - name: Setup a mysql percona server
     hosts: all
     vars_files:
      - mysql-vars.yaml

     tasks:
     - name: Install percona repository for mysql
       shell: "yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm"
       when: ansible_os_family == "RedHat"

     - name: Disable mysql module for RHEL 8
       shell: "dnf module -y disable mysql"
       when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "8"

     - name: Install mysql percona server
       yum: 
        name: Percona-Server-server-57
        state: present
       when: ansible_os_family == "RedHat"

     - name: Backup configuration files
       shell: "cp {{ mysql_config_file }} {{ mysql_config_file }}.bck " 
    
     - name: Create datadir for instance {{ item.name }}
       file:
        path: {{ item.datadir }}
        state: directory
        mode: 0751
        owner: mysql
        group: mysql
        recurse: yes
       with_items:
        - {{ source }}
        - {{ replica }}
       
     - name: Initialize datadir for instance {{ item.name }}
       shell: "mysqld --initialize-insecure --basedir=/usr --datadir={{ item.datadir }} --console"
       #ignore_errors: yes
       with_items:
        - {{ source }}
        - {{ replica }}