---
   - name: Setup a mysql percona server
     hosts: all
     vars_files:
      - mysql-vars.yaml

     tasks:
     - name: Install percona repository for mysql
       shell: "yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm"
       when: ansible_os_family == "RedHat"

     - name: Disable mysql module for RHEL 8
       shell: "dnf module -y disable mysql"
       when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "8"

     - name: Install mysql percona server
       yum: 
        name: Percona-Server-server-57
        state: present
       when: ansible_os_family == "RedHat"

     - name: Backup configuration files
       shell: "cp {{ mysql_config_file }} {{ mysql_config_file }}.bck "

     - name: Create custom mysqld.cnf file 
       copy:
        src: template/mysqld.cnf
        dest: "{{ mysql_config_dir }}/{{ mysql_config_file }}" 
        force: yes
        
    
     - name: Create datadir for instance {{ item.name }}
       file:
        path: {{ item.datadir }}
        state: directory
        mode: 0751
        owner: mysql
        group: mysql
        recurse: yes
       with_items:
        - {{ source }}
        - {{ replica }}
       
     - name: Initialize datadir for instance {{ item.name }}
       shell: "mysqld --initialize-insecure --basedir=/usr --datadir={{ item.datadir }} --console"
       #ignore_errors: yes
       with_items:
        - {{ source }}
        - {{ replica }}

     - name: start service for instance {{ item }}
       service:
        name: mysqld@{{ item }}
        state: started
       with_items:
        - {{ source.name }}
        - {{ replica.name }}

     - name: Create replica user in source instance and grant replication privillege
       mysql_user:
        login_user: {{ mysql_user }}
        login_password: "{{ mysql_password }}"
        login_port: {{ source.port }}
        login_host: 127.0.0.1
        priv: "*.*:REPLICATION SLAVE"
        name: {{  mysql_rpl_user }}
        password: {{ mysql_rpl_pass }}
        state: present

     - name: Get sources binary log file name and current position
       mysql_replication:
        mode: getprimary
       register: coordinates

     - name: "change master: point replica to master"
       mysql_replication:
        mode: changeprimary
        login_user: root
        login_password: "{{ mysql_password }}"
        primary_host: 127.0.0.1
        primary_port: {{ source.port  }}
        primary_password: "{{ mysql_rpl_pass }}"
        primary_log_file: "{{ register.log_file }}"
        primary_log_pos: "{{ register.log_pos }}"

     # Check Before 
     - name: Check replica replication status.
       mysql_replication:
        mode: getreplica
        login_user: "{{ mysql_root_username }}"
        login_password: "{{ mysql_root_password }}"
        login_port: {{ replica.port  }}
       ignore_errors: true
       register: replica_before

     - name: Start replication 
       mysql_replication:
        mode: startreplica
        login_user: "{{ mysql_root_username }}"
        login_password: "{{ mysql_root_password }}"
        login_port: {{ replica.port  }}
       ignore_errors: true
      
     # Check After 
     - name: Check replica replication status.
       mysql_replication:
        mode: getreplica
        login_user: "{{ mysql_root_username }}"
        login_password: "{{ mysql_root_password }}"
        login_port: {{ replica.port  }}
       ignore_errors: true
       register: replica_after

# FALTA ADICIONAR AS CONDIÇÕES
# TALVEZ INTERPOLAR MAIS VARIÁVEIS
#